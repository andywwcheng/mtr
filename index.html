<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTR Real-Time Arrival App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        header {
            text-align: center;
            padding: 20px 0;
            background-color: #fff;
        }
        .logo {
            height: 60px;
            width: auto;
        }
        .search-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        #search-bar {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .accordion-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .accordion {
            background-color: #fff;
            color: #333;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 18px;
            transition: 0.4s;
            margin-bottom: 5px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
        }
        .accordion::before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            background-color: var(--line-color);
            margin-right: 15px;
            border-radius: 3px;
        }
        .active, .accordion:hover {
            background-color: #f0f0f0;
        }
        .panel {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            border-radius: 0 0 5px 5px;
        }
        .station-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            padding: 15px 0;
        }
        .station-btn {
            padding: 12px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .station-btn:hover {
            background-color: #e0e0e0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .direction {
            margin-bottom: 20px;
        }
        .direction h3 {
            color: #007bff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .error {
            color: red;
            text-align: center;
        }
        .info {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 10px;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .station-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <img src="https://mtrtungchunglineextension.hk/wp-content/themes/mtr1/assets/image/MTR_logo.svg" alt="MTR Logo" class="logo">
    </header>

    <div class="search-container">
        <input type="text" id="search-bar" placeholder="Search for a station...">
    </div>

    <div class="accordion-container" id="accordion-container"></div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        const lineColors = {
            AEL: "#00888A", // Airport Express
            DRL: "#F173AC", // Disneyland Resort Line
            EAL: "#53B7E8", // East Rail Line
            ISL: "#007DC5", // Island Line
            KTL: "#00AB4E", // Kwun Tong Line
            SIL: "#BAC429", // South Island Line
            TKL: "#7D499D", // Tseung Kwan O Line
            TWL: "#ED1D24", // Tsuen Wan Line
            TML: "#923011", // Tuen Ma Line
            TCL: "#F7943E"  // Tung Chung Line
        };

        const mtrData = {
            "AEL": { name: "Airport Express", stations: {
                "AIR": "Airport",
                "AWE": "AsiaWorld Expo",
                "HOK": "Hong Kong",
                "KOW": "Kowloon",
                "TSY": "Tsing Yi"
            }},
            "TCL": { name: "Tung Chung Line", stations: {
                "HOK": "Hong Kong",
                "KOW": "Kowloon",
                "OLY": "Olympic",
                "NAC": "Nam Cheong",
                "LAK": "Lai King",
                "TSY": "Tsing Yi",
                "SUN": "Sunny Bay",
                "TUC": "Tung Chung"
            }},
            "TML": { name: "Tuen Ma Line", stations: {
                "WKS": "Wu Kai Sha",
                "MOS": "Ma On Shan",
                "HEO": "Heng On",
                "TSH": "Tai Shui Hang",
                "SHM": "Shek Mun",
                "CIO": "City One",
                "STW": "Sha Tin Wai",
                "CKT": "Che Kung Temple",
                "TAW": "Tai Wai",
                "HIK": "Hin Keng",
                "KAT": "Kai Tak",
                "SUW": "Sung Wong Toi",
                "TKW": "To Kwa Wan",
                "HOM": "Ho Man Tin",
                "HUH": "Hung Hom",
                "ETS": "East Tsim Sha Tsui",
                "AUS": "Austin",
                "NAC": "Nam Cheong",
                "MEF": "Mei Foo",
                "TWW": "Tsuen Wan West",
                "KSR": "Kam Sheung Road",
                "YUL": "Yuen Long",
                "LOP": "Long Ping",
                "TIS": "Tin Shui Wai",
                "SIH": "Siu Hong",
                "TUM": "Tuen Mun"
            }},
            "TKL": { name: "Tseung Kwan O Line", stations: {
                "NOP": "North Point",
                "QUB": "Quarry Bay",
                "YAT": "Yau Tong",
                "TIK": "Tiu Keng Leng",
                "TKO": "Tseung Kwan O",
                "LHP": "LOHAS Park",
                "HAH": "Hang Hau",
                "POA": "Po Lam"
            }},
            "EAL": { name: "East Rail Line", stations: {
                "ADM": "Admiralty",
                "EXC": "Exhibition Centre",
                "HUH": "Hung Hom",
                "MKK": "Mong Kok East",
                "KOT": "Kowloon Tong",
                "TAW": "Tai Wai",
                "SHT": "Sha Tin",
                "FOT": "Fo Tan",
                "RAC": "Racecourse",
                "UNI": "University",
                "TAP": "Tai Po Market",
                "TWO": "Tai Wo",
                "FAN": "Fanling",
                "SHS": "Sheung Shui",
                "LOW": "Lo Wu",
                "LMC": "Lok Ma Chau"
            }},
            "SIL": { name: "South Island Line", stations: {
                "ADM": "Admiralty",
                "OCP": "Ocean Park",
                "WCH": "Wong Chuk Hang",
                "LET": "Lei Tung",
                "SOH": "South Horizons"
            }},
            "TWL": { name: "Tsuen Wan Line", stations: {
                "CEN": "Central",
                "ADM": "Admiralty",
                "TST": "Tsim Sha Tsui",
                "JOR": "Jordan",
                "YMT": "Yau Ma Tei",
                "MOK": "Mong Kok",
                "PRE": "Prince Edward",
                "SSP": "Sham Shui Po",
                "CSW": "Cheung Sha Wan",
                "LCK": "Lai Chi Kok",
                "MEF": "Mei Foo",
                "LAK": "Lai King",
                "KWF": "Kwai Fong",
                "KWH": "Kwai Hing",
                "TWH": "Tai Wo Hau",
                "TSW": "Tsuen Wan"
            }},
            "ISL": { name: "Island Line", stations: {
                "KET": "Kennedy Town",
                "HKU": "HKU",
                "SYP": "Sai Ying Pun",
                "SHW": "Sheung Wan",
                "CEN": "Central",
                "ADM": "Admiralty",
                "WAC": "Wan Chai",
                "CAB": "Causeway Bay",
                "TIH": "Tin Hau",
                "FOH": "Fortress Hill",
                "NOP": "North Point",
                "QUB": "Quarry Bay",
                "TAK": "Tai Koo",
                "SWH": "Sai Wan Ho",
                "SKW": "Shau Kei Wan",
                "HFC": "Heng Fa Chuen",
                "CHW": "Chai Wan"
            }},
            "KTL": { name: "Kwun Tong Line", stations: {
                "WHA": "Whampoa",
                "HOM": "Ho Man Tin",
                "YMT": "Yau Ma Tei",
                "MOK": "Mong Kok",
                "PRE": "Prince Edward",
                "SKM": "Shek Kip Mei",
                "KOT": "Kowloon Tong",
                "LOF": "Lok Fu",
                "WTS": "Wong Tai Sin",
                "DIH": "Diamond Hill",
                "CHH": "Choi Hung",
                "KOB": "Kowloon Bay",
                "NTK": "Ngau Tau Kok",
                "KWT": "Kwun Tong",
                "LAT": "Lam Tin",
                "YAT": "Yau Tong",
                "TIK": "Tiu Keng Leng"
            }},
            "DRL": { name: "Disneyland Resort Line", stations: {
                "SUN": "Sunny Bay",
                "DIS": "Disneyland Resort"
            }}
        };

        const stationMap = {};
        Object.entries(mtrData).forEach(([line, info]) => {
            Object.entries(info.stations).forEach(([code, name]) => {
                stationMap[code] = { name, line };
            });
        });

        const container = document.getElementById('accordion-container');
        const searchBar = document.getElementById('search-bar');
        const modal = document.getElementById('modal');
        const modalBody = document.getElementById('modal-body');
        const closeBtn = document.querySelector('.close');

        let currentLine = '';
        let currentSta = '';
        let fetchInterval;

        // Build accordion
        const lines = Object.keys(mtrData);
        lines.forEach((lineCode, index) => {
            const lineInfo = mtrData[lineCode];
            const color = lineColors[lineCode];

            const acc = document.createElement('button');
            acc.className = 'accordion';
            acc.textContent = lineInfo.name;
            acc.style.setProperty('--line-color', color);

            const panel = document.createElement('div');
            panel.className = 'panel';

            const grid = document.createElement('div');
            grid.className = 'station-grid';

            Object.entries(lineInfo.stations).sort((a, b) => a[1].localeCompare(b[1])).forEach(([code, name]) => {
                const btn = document.createElement('div');
                btn.className = 'station-btn';
                btn.textContent = `${name} (${code})`;
                btn.dataset.line = lineCode;
                btn.dataset.sta = code;
                btn.onclick = () => openModal(lineCode, code, name);
                grid.appendChild(btn);
            });

            panel.appendChild(grid);
            container.appendChild(acc);
            container.appendChild(panel);

            acc.onclick = function() {
                this.classList.toggle('active');
                const p = this.nextElementSibling;
                if (p.style.maxHeight) {
                    p.style.maxHeight = null;
                } else {
                    p.style.maxHeight = p.scrollHeight + "px";
                }
            };

            // Open first accordion by default
            if (index === 0) {
                acc.classList.add('active');
                panel.style.maxHeight = panel.scrollHeight + "px";
            }
        });

        // Search functionality
        searchBar.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            const buttons = container.querySelectorAll('.accordion');
            const panels = container.querySelectorAll('.panel');

            buttons.forEach((acc, i) => {
                const panel = panels[i];
                const stations = panel.querySelectorAll('.station-btn');
                let hasMatch = false;

                stations.forEach(st => {
                    const text = st.textContent.toLowerCase();
                    if (text.includes(query)) {
                        st.style.display = 'block';
                        hasMatch = true;
                    } else {
                        st.style.display = 'none';
                    }
                });

                if (query === '') {
                    acc.style.display = 'block';
                    panel.style.display = 'block';
                } else if (hasMatch) {
                    acc.style.display = 'block';
                    panel.style.display = 'block';
                    acc.classList.add('active');
                    panel.style.maxHeight = panel.scrollHeight + "px";
                } else {
                    acc.style.display = 'none';
                    panel.style.display = 'none';
                    acc.classList.remove('active');
                    panel.style.maxHeight = null;
                }
            });
        });

        // Modal controls
        closeBtn.onclick = () => {
            modal.style.display = 'none';
            clearInterval(fetchInterval);
        };
        window.onclick = (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
                clearInterval(fetchInterval);
            }
        };

        function openModal(line, sta, stationName) {
            currentLine = line;
            currentSta = sta;
            modalBody.innerHTML = `<div class="modal-header"><h2>${stationName} (${sta}) - ${mtrData[line].name}</h2></div><div class="info">Loading...</div>`;
            modal.style.display = 'flex';
            fetchTrainData();
            clearInterval(fetchInterval);
            fetchInterval = setInterval(fetchTrainData, 30000);
        }

        function fetchTrainData() {
            if (!currentLine || !currentSta) return;
            fetch(`https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php?line=${currentLine}&sta=${currentSta}`)
                .then(res => res.json())
                .then(data => displayModal(data))
                .catch(err => {
                    modalBody.innerHTML += `<p class="error">Error: ${err.message}</p>`;
                });
        }

        function displayModal(data) {
            if (data.status === 0) {
                modalBody.innerHTML = `<p class="error">${data.message}</p>`;
                if (data.url) modalBody.innerHTML += `<p><a href="${data.url}" target="_blank">More information</a></p>`;
                return;
            }

            const key = `${currentLine}-${currentSta}`;
            const stationData = data.data[key];
            if (!stationData) {
                modalBody.innerHTML = '<p class="error">No data available.</p>';
                return;
            }

            const isDelay = data.isdelay === 'Y' ? '<p class="error">Delays reported!</p>' : '';

            let content = `<div class="modal-header"><h2>${stationMap[currentSta].name} (${currentSta})</h2></div>`;
            content += `<p class="info">Update: ${stationData.curr_time} | System: ${stationData.sys_time}</p>${isDelay}`;

            content += displayDirection('UP', stationData.UP || []);
            content += displayDirection('DOWN', stationData.DOWN || []);

            modalBody.innerHTML = content;
        }

        function displayDirection(dir, trains) {
            let html = `<div class="direction"><h3>${dir} Direction</h3>`;
            if (trains.length === 0) {
                html += '<p>No upcoming trains.</p></div>';
                return html;
            }

            const table = `<table>
                <thead><tr>
                    <th>Seq</th><th>Destination</th><th>Platform</th>
                    ${currentLine === 'EAL' ? '<th>Type</th>' : ''}
                    <th>Time</th><th>Min</th><th>Valid</th>
                </tr></thead><tbody>`;

            let rows = '';
            trains.forEach(train => {
                const destName = stationMap[train.dest]?.name || train.dest;
                const via = train.route === 'RAC' ? ' (via Racecourse)' : '';
                const valid = train.valid === 'Y' ? 'Yes' : 'No';
                const timetype = currentLine === 'EAL' ? (train.timetype === 'A' ? 'Arrival' : 'Departure') : '';
                rows += `<tr>
                    <td>${train.seq}</td>
                    <td>${destName}${via}</td>
                    <td>${train.plat}</td>
                    ${currentLine === 'EAL' ? `<td>${timetype}</td>` : ''}
                    <td>${train.time.split(' ')[1]}</td>
                    <td>${train.ttnt}</td>
                    <td>${valid}</td>
                </tr>`;
            });

            html += table + rows + `</tbody></table></div>`;
            return html;
        }
    </script>
</body>
</html>
